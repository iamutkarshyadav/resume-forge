generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(cuid()) @map("_id")
  email           String?         @unique
  name            String?
  passwordHash    String?         // null for OAuth users
  role            Role            @default(USER)
  credits         Int             @default(0)         // PDF download credits
  accounts        Account[]
  refreshTokens   RefreshToken[]
  resumes         Resume[]
  analyses        MatchAnalysis[]
  jobDescriptions JobDescription[]
  applications    Application[]
  plan            UserPlan?
  usageMetrics    UsageMetrics[]
  transactions    BillingTransaction[]
  jobs            Job[]
  onboarding      OnboardingProgress?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Job {
  id          String    @id @default(cuid()) @map("_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String

  type        String    // "analyze_match" | "generate_resume"
  status      String    @default("pending") // "pending", "processing", "completed", "failed"
  
  data        Json      // Input parameters
  idempotencyKey String?
  result      Json?     // Success output
  error       String?   // Failure reason
  retries     Int       @default(0)
  maxRetries  Int       @default(1)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  @@unique([userId, idempotencyKey])
  @@index([status, createdAt])
}

model OnboardingProgress {
  id              String          @id @default(cuid()) @map("_id")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String          @unique

  uploadedResume  Boolean         @default(false)
  completedFirstAnalysis Boolean  @default(false)
  savedJobDescription Boolean     @default(false)
  viewedProgress  Boolean         @default(false)
  skipped         Boolean         @default(false)

  completedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model Account {
  id            String   @id @default(cuid()) @map("_id")
  provider      String
  providerId    String
  accessToken   String?
  refreshToken  String?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String

  createdAt     DateTime @default(now())

  @@unique([provider, providerId])
}

model RefreshToken {
  id        String   @id @default(cuid()) @map("_id")
  tokenHash String

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Resume {
  id           String           @id @default(cuid()) @map("_id")
  filename     String
  sizeKB       Float
  fullText     String
  jsonData     Json?

  uploadedBy   User             @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  uploadedById String

  versions     ResumeVersion[]
  analyses     MatchAnalysis[]
  feedbacks    Feedback[]
  applications Application[]

  createdAt    DateTime         @default(now())
  updatedAt    DateTime?        @updatedAt
}

model ResumeVersion {
  id              String          @id @default(cuid()) @map("_id")
  resume          Resume          @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  resumeId        String

  versionNumber   Int
  title           String?         // User-given title
  sourceType      String          // "upload", "ai_generated", "manual_edit"
  sourceAnalysis  MatchAnalysis?  @relation(fields: [sourceAnalysisId], references: [id], onDelete: SetNull)
  sourceAnalysisId String?        // If generated from an analysis

  fullText        String
  jsonData        Json?

  scoreAtCreation Int?            // Score when this version was created
  scoreImprovement Int?           // Delta from previous version

  applications    Application[]

  createdAt       DateTime        @default(now())
}

model Feedback {
  id        String   @id @default(cuid()) @map("_id")

  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  resumeId  String

  reviewer  String
  content   Json
  createdAt DateTime @default(now())
}

enum Role {
  USER
  ADMIN
}

model MatchAnalysis {
  id              String          @id @default(cuid()) @map("_id")
  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId          String?
  resume          Resume?         @relation(fields: [resumeId], references: [id], onDelete: SetNull)
  resumeId        String?
  jd              JobDescription? @relation(fields: [jdId], references: [id], onDelete: SetNull)
  jdId            String?

  application     Application?    @relation("MatchAnalysisToApplication")

  summary         String
  score           Int
  strengths       String[]
  weaknesses      String[]
  missingSkills   String[]
  recommendations String[]
  generatedResume Json?
  jdText          String?

  generatedVersions ResumeVersion[]

  completenessScore Int?          // Resume completeness (0-100)
  jdRealismScore    Int?          // JD realism detection (0-100)
  hasKeywordStuffing Boolean @default(false)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model JobDescription {
  id             String          @id @default(cuid()) @map("_id")
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String

  title          String          // Job title
  company        String?         // Company name
  fullText       String

  tags           String[]        // ["Frontend", "Senior", "React", etc]
  keySkills      String[]        // Extracted top skills

  analyses       MatchAnalysis[]
  applications   Application[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model Application {
  id             String          @id @default(cuid()) @map("_id")
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String

  resume         Resume          @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  resumeId       String

  resumeVersion  ResumeVersion?  @relation(fields: [resumeVersionId], references: [id], onDelete: SetNull)
  resumeVersionId String?

  jd             JobDescription @relation(fields: [jdId], references: [id], onDelete: Cascade)
  jdId           String

  analysis       MatchAnalysis?  @relation("MatchAnalysisToApplication", fields: [analysisId], references: [id], onDelete: SetNull)
  analysisId     String? @unique

  status         String          @default("draft")  // "draft", "ready", "applied", "rejected", "archived"

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model UserPlan {
  id              String   @id @default(cuid()) @map("_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String   @unique

  planType        String   @default("free")  // "free", "pro", "enterprise"
  analysesPerMonth Int     @default(10)
  savedJdsLimit   Int      @default(5)
  aiGenerationsPerMonth Int @default(3)
  exportModes     String[] @default(["pdf"]) // ["pdf", "docx", "ats", "recruiter"]

  currentMonth    String?  // "2025-01" for tracking usage
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UsageMetrics {
  id                  String   @id @default(cuid()) @map("_id")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String

  month               String   // "2025-01"
  analysesUsed        Int      @default(0)
  aiGenerationsUsed   Int      @default(0)
  jdsSaved            Int      @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, month])
}

model BillingTransaction {
  id              String   @id @default(cuid()) @map("_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  type            String   // "purchase", "deduction", "refund"
  amount          Int      // credits added/deducted
  reason          String?  // "pdf_download", "stripe_checkout_<sessionId>", etc
  stripeSessionId String?
  metadata        Json?

  createdAt       DateTime @default(now())
}
